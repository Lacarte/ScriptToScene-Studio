<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScriptToScene Studio</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%230f1520'/><rect x='4' y='4' width='24' height='24' rx='3' fill='none' stroke='%234ECDC4' stroke-width='2'/><path d='M10 4v24' fill='none' stroke='%234ECDC4' stroke-width='2'/><circle cx='18' cy='16' r='4' fill='none' stroke='%234ECDC4' stroke-width='2'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            accent: { DEFAULT: '#4ECDC4', hover: '#5edfd6', glow: 'rgba(78,205,196,0.2)', dim: 'rgba(78,205,196,0.08)' },
            coral: { DEFAULT: '#FF6B6B', dim: 'rgba(255,107,107,0.08)' },
            surface: { darkest: '#0a0e13', dark: '#0f1520', DEFAULT: '#161d2a', hover: '#1c2536', border: '#1e2a3a' },
          },
          fontFamily: {
            display: ['"Space Grotesk"', 'system-ui', 'sans-serif'],
            body: ['"DM Sans"', 'system-ui', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          },
        }
      }
    }
  </script>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>

  <!-- Toast -->
  <div id="toast-wrap" style="position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px"></div>

  <!-- Confirm Dialog -->
  <div id="confirm-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-5" role="dialog"
    aria-modal="true" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(16px)">
    <div class="card w-full max-w-sm p-6" style="animation: modal-in 0.35s cubic-bezier(0.34,1.56,0.64,1)">
      <div class="flex items-center gap-3 mb-4">
        <div style="width:40px;height:40px;min-width:40px;border-radius:10px;background:rgba(255,107,107,0.12);display:flex;align-items:center;justify-content:center">
          <svg width="20" height="20" fill="none" stroke="var(--coral)" stroke-width="2" stroke-linecap="round" viewBox="0 0 24 24">
            <path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6"/>
            <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
        </div>
        <div>
          <h3 id="confirm-title" class="font-display text-base font-semibold" style="color:var(--text)">Move to Trash?</h3>
          <p id="confirm-desc" class="text-xs mt-0.5" style="color:var(--text-secondary)">This action can be undone from the TRASH folder.</p>
        </div>
      </div>
      <div id="confirm-detail" class="mb-5 p-3 rounded-lg" style="background:var(--bg-darkest);border:1px solid var(--border);display:none">
        <p id="confirm-message" class="text-sm" style="color:var(--text-secondary);line-height:1.5"></p>
      </div>
      <div class="flex gap-2.5">
        <button id="confirm-cancel" class="flex-1 py-2.5 rounded-lg font-medium text-sm hover-secondary"
          style="border:1.5px solid var(--border);color:var(--text-secondary);background:transparent;cursor:pointer">Cancel</button>
        <button id="confirm-ok" class="flex-1 py-2.5 rounded-lg font-semibold text-sm hover-lift-coral"
          style="border:none;background:linear-gradient(135deg,#FF6B6B,#E02D2D);color:white;cursor:pointer">Move to Trash</button>
      </div>
    </div>
  </div>

  <!-- History Picker Modal (for SCENES page) -->
  <div id="history-picker-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-5" role="dialog"
    aria-modal="true" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(16px)">
    <div class="card w-full max-w-md p-5" style="animation: modal-in 0.35s cubic-bezier(0.34,1.56,0.64,1);max-height:70vh;display:flex;flex-direction:column">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-display text-base font-semibold" style="color:var(--text)">Pick Alignment</h3>
        <button onclick="closeHistoryPicker()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="history-picker-list" style="overflow-y:auto;flex:1"></div>
    </div>
  </div>

  <!-- ===== SIDEBAR ===== -->
  <nav id="sidebar">
    <!-- Brand -->
    <div class="flex items-center gap-3 px-5 py-5" style="border-bottom:1px solid var(--border)">
      <div
        style="width:36px;height:36px;min-width:36px;border-radius:10px;background:linear-gradient(135deg,#4ECDC4,#2FB8AE);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 12px rgba(78,205,196,0.3)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2"
          stroke-linecap="round">
          <rect x="2" y="2" width="20" height="20" rx="2" />
          <path d="M7 2v20" />
          <path d="M2 12h5" />
          <circle cx="14.5" cy="12" r="3" />
        </svg>
      </div>
      <div class="brand-text">
        <h1 class="font-display text-base font-bold tracking-tight" style="color:var(--text);line-height:1.1">ScriptToScene</h1>
        <p class="text-[9px] font-bold tracking-[0.2em] uppercase" style="color:var(--accent);margin-top:1px">Studio</p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="flex-1 py-3 flex flex-col gap-0.5">
      <button class="nav-item active" onclick="switchPage('timing')" data-page="timing">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          viewBox="0 0 24 24">
          <path d="M4 7h16M4 12h16M4 17h10" />
          <circle cx="19" cy="17" r="2" />
        </svg>
        <span class="nav-label">TIMING</span>
      </button>
      <button class="nav-item" onclick="switchPage('scenes')" data-page="scenes">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          viewBox="0 0 24 24">
          <rect x="2" y="3" width="20" height="14" rx="2" />
          <path d="M8 21h8" />
          <path d="M12 17v4" />
        </svg>
        <span class="nav-label">SCENES</span>
      </button>
      <button class="nav-item" onclick="switchPage('assets')" data-page="assets">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          viewBox="0 0 24 24">
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <circle cx="8.5" cy="8.5" r="1.5" />
          <path d="M21 15l-5-5L5 21" />
        </svg>
        <span class="nav-label">ASSETS</span>
      </button>
      <button class="nav-item" onclick="switchPage('editor')" data-page="editor">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          viewBox="0 0 24 24">
          <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z" />
        </svg>
        <span class="nav-label">EDITOR</span>
      </button>
    </div>

    <!-- Sidebar collapse toggle -->
    <div style="border-top:1px solid var(--border);padding:12px">
      <button id="sidebar-toggle" onclick="toggleSidebar()" class="nav-item" style="margin:0;width:100%">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          viewBox="0 0 24 24" style="transition:transform 0.3s">
          <path d="M15 18l-6-6 6-6" />
        </svg>
        <span class="nav-label">Collapse</span>
      </button>
    </div>
  </nav>

  <!-- ===== MOBILE BOTTOM NAV ===== -->
  <div id="mobile-nav" style="display:none">
    <button class="active" onclick="switchPage('timing')" data-page="timing">
      <svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" viewBox="0 0 24 24">
        <path d="M4 7h16M4 12h16M4 17h10" /><circle cx="19" cy="17" r="2" />
      </svg>
      TIMING
    </button>
    <button onclick="switchPage('scenes')" data-page="scenes">
      <svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" viewBox="0 0 24 24">
        <rect x="2" y="3" width="20" height="14" rx="2" /><path d="M8 21h8" /><path d="M12 17v4" />
      </svg>
      SCENES
    </button>
    <button onclick="switchPage('assets')" data-page="assets">
      <svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" /><circle cx="8.5" cy="8.5" r="1.5" /><path d="M21 15l-5-5L5 21" />
      </svg>
      ASSETS
    </button>
    <button onclick="switchPage('editor')" data-page="editor">
      <svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" viewBox="0 0 24 24">
        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z" />
      </svg>
      EDITOR
    </button>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div id="main-content">

    <!-- ========================================================== -->
    <!-- PAGE: TIMING (Force Alignment)                             -->
    <!-- ========================================================== -->
    <div id="page-timing" class="page active">
      <div class="max-w-2xl mx-auto px-6 py-8">

        <!-- Header -->
        <div class="mb-6">
          <h2 class="font-display text-2xl font-bold tracking-tight" style="color:var(--text)">Force Alignment</h2>
          <p class="text-sm mt-1" style="color:var(--text-secondary)">Align audio to text with word-level timestamps</p>
        </div>

        <!-- Upload audio -->
        <section class="card p-5 mb-4">
          <label class="block text-[10px] font-bold uppercase tracking-[0.15em] mb-2.5" style="color:var(--text-muted)">Audio File</label>
          <div id="align-drop-zone"
            style="border:2px dashed var(--border);border-radius:10px;padding:32px 16px;text-align:center;cursor:pointer;transition:all 0.2s"
            onclick="document.getElementById('align-file-input').click()"
            ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='rgba(78,205,196,0.04)'"
            ondragleave="this.style.borderColor='var(--border)';this.style.background='transparent'"
            ondrop="event.preventDefault();this.style.borderColor='var(--border)';this.style.background='transparent';handleAlignFileDrop(event)">
            <svg width="28" height="28" fill="none" stroke="var(--text-muted)" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto 8px">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <p id="align-file-label" style="font-size:13px;color:var(--text-muted)">Drop a WAV/MP3 file here or click to browse</p>
            <p id="align-file-info" style="font-size:11px;color:var(--text-secondary);margin-top:4px;display:none"></p>
          </div>
          <input type="file" id="align-file-input" accept=".wav,.mp3,.flac,.ogg" style="display:none" onchange="handleAlignFileSelect(this)">
        </section>

        <!-- Transcript text -->
        <section class="card p-5 mb-4">
          <label class="block text-[10px] font-bold uppercase tracking-[0.15em] mb-2.5" style="color:var(--text-muted)">Transcript</label>
          <textarea id="align-text-input" class="input-field" rows="5"
            placeholder="Paste the transcript text that matches the audio..."
            style="width:100%;font-size:13px;line-height:1.7;resize:vertical;padding:12px 14px;font-family:inherit"></textarea>
          <div class="flex justify-between mt-2" style="font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace">
            <span id="align-text-count">0 words</span>
            <span>English only</span>
          </div>
        </section>

        <!-- Align button -->
        <button id="align-run-btn" onclick="handleRunAlignment()" class="gen-btn w-full"
          style="padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;font-family:'JetBrains Mono','Fira Code',monospace;letter-spacing:0.02em;color:white;cursor:pointer;transition:all 0.3s cubic-bezier(0.16,1,0.3,1);border:none;position:relative;overflow:hidden">
          <span id="align-btn-spinner" style="display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:8px"></span>
          <span id="align-btn-label">Run Alignment</span>
        </button>

        <!-- Results -->
        <div id="align-results" style="display:none;margin-top:20px">
          <section class="card p-5">
            <div class="flex items-center justify-between mb-3">
              <label class="block text-[10px] font-bold uppercase tracking-[0.15em]" style="color:var(--text-muted)">Results</label>
              <div style="display:flex;gap:6px">
                <button onclick="copyAlignJSON()" title="Copy JSON" class="action-btn hover-accent">Copy JSON</button>
                <button onclick="downloadAlignJSON()" title="Download JSON" class="action-btn hover-accent">Download</button>
                <button onclick="deleteAlignResult()" title="Move to Trash" class="action-btn hover-coral-border">Delete</button>
              </div>
            </div>
            <div id="align-results-stats" class="font-mono" style="font-size:11px;color:var(--text-secondary);margin-bottom:10px"></div>
            <div id="align-results-words" style="display:flex;flex-wrap:wrap;gap:3px 4px;line-height:2;max-height:300px;overflow-y:auto;padding-right:4px"></div>
          </section>
        </div>

        <!-- History -->
        <div style="margin-top:28px">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-display text-lg font-bold" style="color:var(--text)">History</h3>
            <span id="history-count" class="font-mono text-xs" style="color:var(--text-muted)">0 files</span>
          </div>
          <div id="history-list"></div>
        </div>

      </div>
    </div>

    <!-- ========================================================== -->
    <!-- PAGE: SCENES (AI Scene Script Generator)                   -->
    <!-- ========================================================== -->
    <div id="page-scenes" class="page">
      <div class="max-w-3xl mx-auto px-6 py-8">

        <!-- Header -->
        <div class="mb-6">
          <h2 class="font-display text-2xl font-bold tracking-tight" style="color:var(--text)">Scene Generator</h2>
          <p class="text-sm mt-1" style="color:var(--text-secondary)">Transform word-level timestamps into AI-powered visual scene scripts</p>
        </div>

        <!-- Alignment Source -->
        <section class="card p-5 mb-4">
          <label class="block text-[10px] font-bold uppercase tracking-[0.15em] mb-2.5" style="color:var(--text-muted)">Alignment Source</label>
          <div class="flex gap-3 mb-3">
            <button onclick="useCurrentAlignmentForScenes()" class="action-btn hover-accent" style="padding:6px 14px;font-size:11px">Use Current Result</button>
            <button onclick="pickHistoryForScenes()" class="action-btn hover-accent" style="padding:6px 14px;font-size:11px">Pick from History</button>
          </div>
          <div id="scenes-source-info" class="font-mono" style="font-size:12px;color:var(--text-muted)">No alignment selected</div>
          <div id="scenes-json-preview" style="display:none;margin-top:10px;max-height:150px;overflow-y:auto;background:var(--bg-darkest);border-radius:8px;padding:12px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-secondary);white-space:pre-wrap"></div>
        </section>

        <!-- Settings -->
        <section class="card p-5 mb-4">
          <label class="block text-[10px] font-bold uppercase tracking-[0.15em] mb-2.5" style="color:var(--text-muted)">Generation Settings</label>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1" style="color:var(--text-secondary)">Style Preset</label>
              <select id="scenes-style" class="input-field" style="width:100%;padding:8px 12px;font-size:12px;font-family:inherit">
                <option value="cinematic">Cinematic Realistic</option>
                <option value="anime">Anime / Manga</option>
                <option value="abstract">Abstract / Artistic</option>
                <option value="minimal">Minimalist</option>
              </select>
            </div>
            <div>
              <label class="block text-xs mb-1" style="color:var(--text-secondary)">Aspect Ratio</label>
              <select id="scenes-aspect" class="input-field" style="width:100%;padding:8px 12px;font-size:12px;font-family:inherit">
                <option value="9:16">9:16 (Vertical / Reels)</option>
                <option value="16:9">16:9 (Landscape)</option>
                <option value="1:1">1:1 (Square)</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Generate Button -->
        <button id="scenes-generate-btn" onclick="handleGenerateScenes()" class="gen-btn w-full"
          style="padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;font-family:'JetBrains Mono','Fira Code',monospace;letter-spacing:0.02em;color:white;cursor:pointer;transition:all 0.3s cubic-bezier(0.16,1,0.3,1);border:none;position:relative;overflow:hidden">
          <span id="scenes-btn-spinner" style="display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:8px"></span>
          <span id="scenes-btn-label">Generate Scene Script</span>
        </button>

        <!-- Results -->
        <div id="scenes-results" style="display:none;margin-top:20px">
          <div class="flex items-center justify-between mb-3">
            <label class="block text-[10px] font-bold uppercase tracking-[0.15em]" style="color:var(--text-muted)">Generated Scenes</label>
            <div style="display:flex;gap:6px">
              <button onclick="copyScenesJSON()" class="action-btn hover-accent">Copy JSON</button>
              <button onclick="downloadScenesJSON()" class="action-btn hover-accent">Download</button>
              <button onclick="sendToAssets()" class="action-btn hover-accent" style="border-color:var(--accent);color:var(--accent)">Send to Assets</button>
              <button onclick="sendToEditor()" class="action-btn hover-accent" style="border-color:var(--accent);color:var(--accent)">Send to Editor</button>
            </div>
          </div>
          <div id="scenes-stats" class="font-mono" style="font-size:11px;color:var(--text-secondary);margin-bottom:10px"></div>
          <div id="scenes-list" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <!-- Scenes History -->
        <div style="margin-top:28px">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-display text-lg font-bold" style="color:var(--text)">Scene History</h3>
            <span id="scenes-history-count" class="font-mono text-xs" style="color:var(--text-muted)">0 projects</span>
          </div>
          <div id="scenes-history-list"></div>
        </div>

      </div>
    </div>

    <!-- ========================================================== -->
    <!-- PAGE: ASSETS (Image Generation & Management)               -->
    <!-- ========================================================== -->
    <div id="page-assets" class="page">
      <div class="max-w-4xl mx-auto px-6 py-8">

        <!-- Header -->
        <div class="mb-6">
          <h2 class="font-display text-2xl font-bold tracking-tight" style="color:var(--text)">Asset Manager</h2>
          <p class="text-sm mt-1" style="color:var(--text-secondary)">Generate and manage images for each scene</p>
        </div>

        <!-- Source Info -->
        <section class="card p-4 mb-4">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
              <span id="assets-source-label" class="font-mono text-xs" style="color:var(--text-muted)">No scenes loaded</span>
            </div>
            <div style="display:flex;gap:6px">
              <button onclick="loadScenesForAssets()" class="action-btn hover-accent" style="padding:6px 14px;font-size:11px">Load from Scenes</button>
              <button onclick="importAssetsJSON()" class="action-btn hover-accent" style="padding:6px 14px;font-size:11px">Import JSON</button>
              <input type="file" id="assets-json-input" accept=".json" style="display:none" onchange="handleAssetsJSONImport(this)">
            </div>
          </div>
        </section>

        <!-- Generation Controls -->
        <section class="card p-5 mb-4">
          <label class="block text-[10px] font-bold uppercase tracking-[0.15em] mb-2.5" style="color:var(--text-muted)">Image Generation</label>
          <div class="flex gap-3 items-center flex-wrap">
            <select id="assets-provider" class="input-field" style="padding:8px 12px;font-size:12px;font-family:inherit">
              <option value="midjourney">Midjourney</option>
              <option value="meta-ai">Meta AI (Imagine)</option>
            </select>
            <button onclick="generateAllImages()" class="gen-btn" style="padding:10px 20px;border-radius:10px;font-size:12px;font-weight:600;color:white;border:none;cursor:pointer;white-space:nowrap">Generate All</button>
            <span id="assets-progress" class="font-mono text-xs" style="color:var(--text-muted)">0 / 0 complete</span>
          </div>
        </section>

        <!-- Asset Grid -->
        <div id="assets-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"></div>

        <!-- Empty State -->
        <div id="assets-empty" style="text-align:center;padding:48px 0;color:var(--text-muted);font-size:13px">
          <svg width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto 12px;opacity:0.5">
            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
          </svg>
          <p>No scenes loaded. Generate scenes first or import a JSON file.</p>
        </div>

      </div>
    </div>

    <!-- ========================================================== -->
    <!-- PAGE: EDITOR (Timeline Editor)                             -->
    <!-- ========================================================== -->
    <div id="page-editor" class="page" style="height:100vh;overflow:hidden">
      <div id="editor-loading" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:13px">
        <div style="text-align:center">
          <svg width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto 12px;opacity:0.5">
            <rect x="2" y="2" width="20" height="20" rx="2" />
            <path d="M7 2v20" /><path d="M2 12h5" />
            <circle cx="14.5" cy="12" r="3" />
          </svg>
          <p>Loading Timeline Editor...</p>
          <p style="font-size:11px;margin-top:4px;color:var(--text-muted);opacity:0.7">Make sure the editor server is running</p>
        </div>
      </div>
      <iframe id="editor-iframe" style="display:none;width:100%;height:100%;border:none" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
    </div>

  </div>

  <!-- ===== JavaScript Modules ===== -->
  <script src="js/app.js"></script>
  <script src="js/timing.js"></script>
  <script src="js/scenes.js"></script>
  <script src="js/assets.js"></script>
  <script src="js/editor.js"></script>
</body>
</html>
